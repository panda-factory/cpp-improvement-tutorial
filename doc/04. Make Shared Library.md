---
title: RAII
type: book-zh-cn
order: 2
---

# 第3章 动态库

最近熊猫的项目组要开发一款Windows下的C++的动态库，发现组内很多兄弟对动态库…………

- 本文针对Windows下的.dll作介绍分析，Linux下的除了库的形式不一样，整体概念还是相同的。
- 本文的编译脚本使用CMake进行构建，这适用于大部分的跨平台程序场景。

使用VS工具，用dumpbin命令查看程序的运行依赖。可以看到对于main.exe依赖的动态库有libshared.dll、MSVCP140D.dll……等。其中libshared.dll是后面会介绍如果自行编译的动态库，其他都是Windows程序依赖的MSVC工具链的环境，可以不管。
```shell
dumpbin /dependents main.exe
Microsoft (R) COFF/PE Dumper Version 14.28.29913.0
Copyright (C) Microsoft Corporation.  All rights reserved.


Dump of file main.exe

File Type: EXECUTABLE IMAGE

  Image has the following dependencies:

    libshared.dll
    MSVCP140D.dll
    VCRUNTIME140_1D.dll
    VCRUNTIME140D.dll
    ucrtbased.dll
    KERNEL32.dll
```

那么程序如何链接动态库，并找到动态库的呢？

## 编译动态库
这里我们先创建一个简单的动态库libshared.dll，Code很简单，就是提供一个函数做打印。
- Header File
```C++
// Shared.h
class Shared : public AllStatic {
public:
    static void Test();
};
```
- Source File
```C++
#include "Shared.h"
#include <iostream>

void Shared::Test() {
    std::cout << "Shared::Test." << std::endl;
}
```
- CMake
```CMake
SET(SHARED_SRC "${CMAKE_CURRENT_SOURCE_DIR}/Shared.cpp")

ADD_LIBRARY(libshared SHARED ${SHARED_SRC})
```

编译后，可以获得动态库libshared.dll。但这个动态库并不能被直接使用，先用VS工具查看dll的符号表，可以看到库中竟然没有任何符号，所以这个库是无法之间LINK使用的。
```shell
dumpbin /symbols libshared.dll
Microsoft (R) COFF/PE Dumper Version 14.28.29913.0
Copyright (C) Microsoft Corporation.  All rights reserved.


Dump of file libshared.dll

File Type: DLL

  Summary

        1000 .00cfg
        1000 .data
        2000 .idata
        1000 .pdata
        3000 .rdata
        1000 .reloc
        1000 .rsrc
        9000 .text
```